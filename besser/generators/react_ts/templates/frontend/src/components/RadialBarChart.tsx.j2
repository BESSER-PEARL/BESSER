{% raw %}
import React, { useEffect, useState } from "react";
import {
  RadialBarChart,
  RadialBar,
  Legend,
  Tooltip,
  ResponsiveContainer,
} from "recharts";
import chroma from "chroma-js";

const colorPalettes: Record<string, string[]> = {
  blues: ["#cce5ff", "#66b3ff", "#3399ff", "#0066cc"],
  warm: ["#ffcc99", "#ff9966", "#ff6633", "#cc3300"],
  cool: ["#99ffcc", "#33ff99", "#00cc66", "#00994d"],
  vibrant: ["#ff0080", "#ff6600", "#ffff00", "#00ff00", "#00ffff", "#8000ff"],
  greenBlue: ["#1B4F72", "#2E86C1", "#117A65", "#1ABC9C", "#148F77"],
  warmPro: ["#D35400", "#E67E22", "#F39C12", "#D68910", "#BA4A00"],
  neutral: ["#34495E", "#5D6D7E", "#85929E", "#AAB7B8", "#CCD1D1"],
  classic: ["#0088FE", "#00C49F", "#FFBB28", "#FF8042"],
  default: ["#8884d8", "#82ca9d", "#8B9CC5", "#89B3B2"],
};

const getColorsFromPalette = (paletteName: string, count: number) => {
  const palette = colorPalettes[paletteName] || colorPalettes.default;
  return palette.length >= count
    ? palette.slice(0, count)
    : chroma.scale(palette).mode("lab").colors(count);
};

interface RadialBarChartComponentProps {
  endpoint?: string;
  featuresKey?: string;
  valuesKey?: string;
  startAngle?: number;
  endAngle?: number;
  colorPalette?: string;
  width?: number;
  height?: number;
}

const RadialBarChartComponent: React.FC<RadialBarChartComponentProps> = ({
  endpoint,
  featuresKey = "name",
  valuesKey = "value",
  startAngle = 180,
  endAngle = -180,
  colorPalette = "blues",
  width = 350,
  height = 350,
}) => {
  const [data, setData] = useState<any[]>([]);

  useEffect(() => {
    if (!endpoint) return;
    fetch(endpoint)
      .then((res) => res.json())
      .then((json) => setData(json));
  }, [endpoint]);

  const colors = getColorsFromPalette(colorPalette, data.length);

  const coloredData = data.map((d, i) => ({
    ...d,
    fill: colors[i],
  }));

  return (
    <div style={{ width: "100%", height: "100%" }}>
      <ResponsiveContainer width="100%" height="100%">
        <RadialBarChart
          cx="50%"
          cy="50%"
          innerRadius="10%"
          outerRadius="80%"
          barSize={20}
          data={coloredData}
          startAngle={startAngle}
          endAngle={endAngle}
        >
          <RadialBar
            dataKey={valuesKey}
            background
            label={{ position: "inside", fill: "#fff", style: { fontSize: "12px" } }}
          />
          <Legend
            iconSize={15}
            layout="vertical"
            verticalAlign="middle"
            align="right"
            formatter={(value: string, entry: any) => entry.payload[featuresKey]}
          />
          <Tooltip />
        </RadialBarChart>
      </ResponsiveContainer>
    </div>
  );
};

export default RadialBarChartComponent;
{% endraw %}
