import React, { CSSProperties, useEffect, useState } from "react";
import axios from "axios";
import { useNavigate } from "react-router-dom";
import { applyStyle, StyleData } from "../utils/applyStyle";
import { BarChartComponent } from "./charts/BarChartComponent";
import { LineChartComponent } from "./charts/LineChartComponent";
import { PieChartComponent } from "./charts/PieChartComponent";
import { RadialBarChartComponent } from "./charts/RadialBarChartComponent";
import { RadarChartComponent } from "./charts/RadarChartComponent";

export interface RendererProps {
  component: any;
  styles: StyleData[];
}

export const Renderer: React.FC<RendererProps> = ({ component, styles }) => {
  // BrowserRouter should be set up in index.tsx - hooks must be called unconditionally
  const navigate = useNavigate();
  
  // All hooks must be at the top level - declare all states here
  const [chartData, setChartData] = useState<any[]>(component.data ?? []);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [listData, setListData] = useState<any[]>([]);
  
  let style = applyStyle(`#${component.id}`, styles) as CSSProperties;
  if (component.class_list && Array.isArray(component.class_list)) {
    component.class_list.forEach((cls: string) => {
      style = { ...style, ...applyStyle(cls, styles) };
    });
  }

  // Chart data fetching effect
  useEffect(() => {
    if (["bar-chart", "line-chart", "pie-chart", "radial-bar-chart", "radar-chart"].includes(component.type)) {
      const endpoint = component.data_binding?.endpoint;
      if (endpoint) {
        setLoading(true);
        setError(null);
        // Always use backend base URL for relative endpoints
        const backendBase = "http://localhost:8000";
        const url = endpoint.startsWith("/") ? backendBase + endpoint : endpoint;
        axios.get(url)
          .then((res) => {
            console.log("API response:", res.data); // Debug log
            let data = Array.isArray(res.data)
              ? res.data
              : (
                  res.data.sensor ||
                  res.data.measure ||
                  res.data.measures ||
                  res.data.results ||
                  []
                );
            if (!Array.isArray(data)) data = [];
            setChartData(data);
          })
          .catch(() => {
            setError("Error loading data");
            setChartData([]);
          })
          .finally(() => setLoading(false));
      }
    }
  }, [component.type, component.data_binding?.endpoint]);

  // Data list fetching effect
  useEffect(() => {
    if (component.type === "data-list" && component.data_sources && component.data_sources.length > 0) {
      const source = component.data_sources[0];
      const endpoint = source.endpoint || `/${source.domain?.toLowerCase()}/`;
      if (endpoint) {
        const backendBase = "http://localhost:8000";
        const url = endpoint.startsWith("/") ? backendBase + endpoint : endpoint;
        axios.get(url)
          .then((res) => {
            let data = Array.isArray(res.data) ? res.data : (res.data.results || []);
            setListData(data);
          })
          .catch(() => setListData([]));
      }
    }
  }, [component.type, component.data_sources]);

  if (component.type === "container" || component.type === "wrapper" || component.type === "component") {
    // Use the actual HTML tag if available, otherwise default to div
    const validTags = ["section", "article", "header", "footer", "nav", "aside", "main", "div", "ul", "ol", "li"];
    const tagName = (component.tag && validTags.includes(component.tag.toLowerCase())) 
      ? component.tag.toLowerCase()
      : "div";
    return React.createElement(
      tagName,
      {
        id: component.id,
        style: style,
        className: component.class_list?.join(' '),
        ...(component.attributes || {})
      },
      (component.children ?? []).map((child: any) => (
        <Renderer key={child.id} component={child} styles={styles} />
      ))
    );
  }

  if (component.type === "text") {
    // Use the actual HTML tag if available, otherwise default to p
    const validTags = ["h1", "h2", "h3", "h4", "h5", "h6", "p", "span", "div", "strong", "em", "li"];
    const tagName = (component.tag && validTags.includes(component.tag.toLowerCase())) 
      ? component.tag.toLowerCase()
      : "p";
    return React.createElement(
      tagName,
      {
        id: component.id,
        style: style,
        className: component.class_list?.join(' '),
        ...(component.attributes || {})
      },
      component.content || ""
    );
  }

  if (component.type === "button" || component.type === "action-button") {
    const handleClick = () => {
      // Handle button events
      if (component.events && Array.isArray(component.events)) {
        component.events.forEach((event: any) => {
          if (event.type === "onClick" && event.actions) {
            event.actions.forEach((action: any) => {
              if (action.kind === "Transition" && action.target_screen_path) {
                navigate(action.target_screen_path);
              } else if (action.kind === "Transition" && action.target_screen) {
                // Fallback to target screen name if path not available
                const targetPath = `/${action.target_screen.toLowerCase().replace(/\s+/g, '-')}`;
                navigate(targetPath);
              }
            });
          }
        });
      }
      // Fallback to targetScreen if events not available
      else if (component.target_screen_path) {
        navigate(component.target_screen_path);
      }
    };
    
    return (
      <button
        id={component.id}
        type={component.attributes?.type || "button"}
        style={style}
        className={component.class_list?.join(' ')}
        onClick={handleClick}
        {...(component.attributes || {})}
      >
        {component.label || component.name || "Button"}
      </button>
    );
  }

  if (component.type === "link" || component.type === "link-button") {
    const handleClick = (e: React.MouseEvent<HTMLAnchorElement>) => {
      // Handle internal navigation
      if (component.target_screen_path && !component.url?.startsWith('http') && component.url !== '#') {
        e.preventDefault();
        navigate(component.target_screen_path);
      }
      // Let default link behavior handle external URLs
    };
    
    return (
      <a
        id={component.id}
        href={component.url || "#"}
        target={component.target || undefined}
        rel={component.rel || undefined}
        style={style}
        className={component.class_list?.join(' ')}
        onClick={handleClick}
        {...(component.attributes || {})}
      >
        {component.label || component.name || ""}
      </a>
    );
  }

  if (component.type === "image") {
    return (
      <img
        id={component.id}
        src={component.src || ""}
        alt={component.alt || component.description || ""}
        style={style}
        className={component.class_list?.join(' ')}
        {...(component.attributes || {})}
      />
    );
  }

  if (component.type === "input") {
    return (
      <input
        id={component.id}
        type={component.input_type?.toLowerCase() || "text"}
        placeholder={component.attributes?.placeholder || ""}
        style={style}
        className={component.class_list?.join(' ')}
        {...(component.attributes || {})}
      />
    );
  }

  if (component.type === "form") {
    const handleSubmit = (e: React.FormEvent) => {
      e.preventDefault();
      // Handle form submission
      console.log("Form submitted:", component.name);
    };
    
    return (
      <form
        id={component.id}
        onSubmit={handleSubmit}
        style={style}
        className={component.class_list?.join(' ')}
        {...(component.attributes || {})}
      >
        {(component.inputs || []).map((input: any) => (
          <div key={input.id} style={{ marginBottom: "10px" }}>
            <label htmlFor={input.id} style={{ display: "block", marginBottom: "5px" }}>
              {input.label || input.id}
            </label>
            <Renderer key={input.id} component={{ ...input, type: "input" }} styles={styles} />
          </div>
        ))}
        <button type="submit">Submit</button>
      </form>
    );
  }

  if (component.type === "menu") {
    return (
      <nav id={component.id} style={style} className={component.class_list?.join(' ')} {...(component.attributes || {})}>
        <ul style={{ listStyle: "none", padding: 0, margin: 0 }}>
          {(component.items || []).map((item: any, index: number) => (
            <li key={index} style={{ display: "inline-block", marginRight: "15px" }}>
              <a
                href={item.url || "#"}
                target={item.target || undefined}
                rel={item.rel || undefined}
              >
                {item.label}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    );
  }

  if (component.type === "data-list") {
    return (
      <div id={component.id} style={style} className={component.class_list?.join(' ')} {...(component.attributes || {})}>
        <ul>
          {listData.map((item: any, index: number) => (
            <li key={index}>{JSON.stringify(item)}</li>
          ))}
        </ul>
      </div>
    );
  }

  if (component.type === "embedded-content") {
    return (
      <iframe
        id={component.id}
        src={component.src || ""}
        title={component.description || component.name}
        style={style}
        className={component.class_list?.join(' ')}
        {...(component.attributes || {})}
      />
    );
  }

  if (component.type === "radar-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <RadarChartComponent
        id={component.id}
        title={component.title || component.name}
        color={component.color}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  if (component.type === "bar-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <BarChartComponent
        id={component.id}
        title={component.title || component.name}
        color={component.color}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  if (component.type === "line-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <LineChartComponent
        id={component.id}
        title={component.title || component.name}
        color={component.color}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  if (component.type === "pie-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <PieChartComponent
        id={component.id}
        title={component.title || component.name}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  if (component.type === "radial-bar-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <RadialBarChartComponent
        id={component.id}
        title={component.title || component.name}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  return (
    <div id={component.id} style={style}>
      <strong>{component.name || component.type}</strong>
      <pre style={{ whiteSpace: "pre-wrap" }}>
        {JSON.stringify(component, null, 2)}
      </pre>
    </div>
  );
};