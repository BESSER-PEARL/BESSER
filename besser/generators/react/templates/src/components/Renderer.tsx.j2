import React, { CSSProperties, useEffect, useState } from "react";
import axios from "axios";
import { applyStyle, StyleData } from "../utils/applyStyle";
import { BarChartComponent } from "./charts/BarChartComponent";
import { LineChartComponent } from "./charts/LineChartComponent";

export interface RendererProps {
  component: any;
  styles: StyleData[];
}

export const Renderer: React.FC<RendererProps> = ({ component, styles }) => {
  let style = applyStyle(`#${component.id}`, styles) as CSSProperties;
  if (component.class_list && Array.isArray(component.class_list)) {
    component.class_list.forEach((cls: string) => {
      style = { ...style, ...applyStyle(cls, styles) };
    });
  }

  // Chart data state and fetching
  const [chartData, setChartData] = useState<any[]>(component.data ?? []);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (component.type === "bar-chart" || component.type === "line-chart") {
      const endpoint = component.data_binding?.endpoint;
      if (endpoint) {
        setLoading(true);
        setError(null);
        // Always use backend base URL for relative endpoints
        const backendBase = "http://localhost:8000";
        const url = endpoint.startsWith("/") ? backendBase + endpoint : endpoint;
        axios.get(url)
          .then((res) => {
            console.log("API response:", res.data); // Debug log
            let data = Array.isArray(res.data)
              ? res.data
              : (
                  res.data.sensor ||
                  res.data.measure ||
                  res.data.measures ||
                  res.data.results ||
                  []
                );
            if (!Array.isArray(data)) data = [];
            setChartData(data);
          })
          .catch(() => {
            setError("Error loading data");
            setChartData([]);
          })
          .finally(() => setLoading(false));
      }
    }
  }, [component.type, component.data_binding?.endpoint]);

  if (component.type === "container" || component.type === "wrapper") {
    return (
      <div id={component.id} style={style} className={component.class_list?.join(' ')}>
        {(component.children ?? []).map((child: any) => (
          <Renderer key={child.id} component={child} styles={styles} />
        ))}
      </div>
    );
  }

  if (component.type === "text") {
    return (
      <p id={component.id} style={style}>
        {component.content || ""}
      </p>
    );
  }

  if (component.type === "bar-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <BarChartComponent
        id={component.id}
        title={component.title || component.name}
        color={component.color}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  if (component.type === "line-chart") {
    if (loading) return <div id={component.id}>Loading data...</div>;
    if (error) return <div id={component.id}>{error}</div>;
    return (
      <LineChartComponent
        id={component.id}
        title={component.title || component.name}
        color={component.color}
        data={chartData}
        labelField={component.data_binding?.label_field}
        dataField={component.data_binding?.data_field}
        options={component.chart || {}}
        styles={style}
      />
    );
  }

  return (
    <div id={component.id} style={style}>
      <strong>{component.name || component.type}</strong>
      <pre style={{ whiteSpace: "pre-wrap" }}>
        {JSON.stringify(component, null, 2)}
      </pre>
    </div>
  );
};